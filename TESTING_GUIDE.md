# 测试指南 - Media3 音频时长修复

## 修复内容

本次修复解决了 Media3 在处理超过 20 分钟音频文件时无法获取正确时长和无法拖动进度条的问题。

## 修改的文件

1. **app/src/main/java/com/zjr/hesimusic/di/MediaModule.kt**
   - 添加了 `DefaultExtractorsFactory` 配置
   - 启用了常量比特率 seeking (`setConstantBitrateSeekingEnabled(true)`)
   - 配置了 `DefaultMediaSourceFactory` 使用自定义的 extractors factory

## 测试步骤

### 前置条件

准备以下测试文件：
1. **短音频文件** (< 5 分钟) - 用于验证现有功能未受影响
2. **中等长度音频文件** (10-20 分钟) - 用于边界测试
3. **长音频文件** (> 20 分钟) - 主要测试目标
   - 推荐使用有声书或播客文件
   - 最好包含 VBR 和 CBR 编码的 MP3 文件
4. **超长音频文件** (> 1 小时) - 压力测试

### 测试场景

#### 场景 1: 基础播放功能

**目的**: 验证音频文件可以正常加载和播放

**步骤**:
1. 启动 HesiMusic 应用
2. 扫描包含测试文件的文件夹
3. 选择一个超过 20 分钟的音频文件
4. 点击播放

**预期结果**:
- ✅ 文件正常开始播放
- ✅ 播放控制界面正确显示
- ✅ 音频输出正常

#### 场景 2: 时长显示

**目的**: 验证应用能够正确获取和显示音频时长

**步骤**:
1. 播放一个超过 20 分钟的音频文件
2. 观察播放器界面显示的时长
3. 与文件的实际时长进行对比

**预期结果**:
- ✅ 时长显示正确（误差在几秒内可接受）
- ✅ 时长格式正确（例如：25:30 表示 25 分 30 秒）
- ✅ 不会显示异常时长（如显示 1 小时但实际只有 7 分钟）

#### 场景 3: 进度条拖动

**目的**: 验证可以通过拖动进度条进行 seek 操作

**步骤**:
1. 播放一个超过 20 分钟的音频文件
2. 等待播放 1-2 分钟
3. 拖动进度条到不同位置：
   - 拖动到开头（0%）
   - 拖动到中间（50%）
   - 拖动到接近结尾（90%）
4. 每次拖动后观察播放位置

**预期结果**:
- ✅ 进度条可以拖动
- ✅ 松手后音频从新位置开始播放
- ✅ seek 操作流畅，没有明显延迟
- ✅ seek 后的位置基本准确（VBR 文件可能有小幅偏差）

#### 场景 4: 快进/快退按钮

**目的**: 验证使用播放控制按钮的 seek 功能

**步骤**:
1. 播放一个超过 20 分钟的音频文件
2. 使用"下一首"按钮（如果播放列表有多首歌曲）
3. 使用"上一首"按钮
4. 如果有快进/快退功能，测试这些按钮

**预期结果**:
- ✅ 所有导航按钮正常工作
- ✅ 切换歌曲时正确加载新文件
- ✅ 时长和进度正确更新

#### 场景 5: 播放状态恢复

**目的**: 验证应用关闭后重新打开时能恢复正确的播放位置

**步骤**:
1. 播放一个超过 20 分钟的音频文件
2. 拖动到中间位置（如 15 分钟处）
3. 暂停播放
4. 完全关闭应用
5. 重新打开应用

**预期结果**:
- ✅ 应用记住了上次播放的文件
- ✅ 播放位置恢复到关闭前的位置（误差在几秒内）
- ✅ 时长显示正确

#### 场景 6: 不同编码格式测试

**目的**: 验证对不同编码格式 MP3 的支持

**步骤**:
1. 测试 CBR (恒定比特率) MP3 文件
2. 测试 VBR (可变比特率) MP3 文件
3. 测试带有完整 Xing 头的 VBR 文件
4. 测试缺少元数据的 MP3 文件

**预期结果**:
- ✅ CBR 文件：时长和 seek 完全准确
- ✅ VBR 文件：时长基本准确，seek 可能有小幅偏差（可接受）
- ✅ 所有文件都能正常播放和拖动进度条

#### 场景 7: 短文件兼容性测试

**目的**: 确保修复不影响短音频文件的播放

**步骤**:
1. 播放短音频文件（< 5 分钟）
2. 测试所有基本功能（播放、暂停、seek）

**预期结果**:
- ✅ 短文件功能正常
- ✅ 时长准确
- ✅ seek 精确

### 回归测试

确保以下现有功能未受影响：

- [ ] 播放列表管理
- [ ] 收藏功能
- [ ] 均衡器
- [ ] 睡眠定时器
- [ ] 通知栏控制
- [ ] 音频焦点处理
- [ ] 后台播放

## 性能测试

### CPU 使用率
- 监控播放长音频文件时的 CPU 使用率
- 应该与短文件相似，没有明显增加

### 内存使用
- 监控播放长音频文件时的内存占用
- 不应该有内存泄漏

### 电池消耗
- 长时间播放（1 小时+）的电池消耗应该合理

## 已知限制

根据 Media3 的文档和已知问题：

1. **VBR MP3 的 seek 精度**
   - 对于缺少 Xing 头的 VBR MP3，seek 可能有几秒的偏差
   - 这是可接受的权衡，以换取即时的 seekability

2. **流式音频**
   - 对于网络流式音频，时长获取可能需要更长时间
   - 这不在本次修复范围内

## 问题上报

如果在测试中发现问题，请记录：

1. **设备信息**
   - Android 版本
   - 设备型号

2. **文件信息**
   - 文件格式（MP3、FLAC 等）
   - 编码类型（CBR/VBR）
   - 文件大小和时长
   - 比特率

3. **问题描述**
   - 具体现象
   - 复现步骤
   - 预期行为 vs 实际行为

4. **日志**
   - Logcat 输出（如果可能）
   - 应用崩溃信息（如果有）

## 成功标准

测试通过的标准：

- ✅ 所有超过 20 分钟的音频文件都能显示正确的时长
- ✅ 进度条可以在长音频文件中正常拖动
- ✅ seek 操作响应迅速（< 1 秒）
- ✅ 短音频文件功能未受影响
- ✅ 没有新的崩溃或错误
- ✅ 性能没有明显下降

## 下一步

如果测试通过，可以考虑：

1. 升级到 Media3 1.6.0 以获得更好的 MP3 支持
2. 添加音频文件元数据显示功能
3. 实现更详细的错误提示
