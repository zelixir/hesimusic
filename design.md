## design 

本项目是一个Android音乐播放器, 用于播放设备本地储存的各种格式音乐, 并支持cue文件
目标是替换天天动听
本项目的绝大部分代码由AI生成

## 功能清单

- [ ] 扫描本地音乐
  - [ ] 支持常见的音乐格式
  - [ ] 支持cue文件
  - [ ] 支持常见的标签格式(id3等)
  - [ ] 支持自动识别非UTF8的中文和日文字符编码
  - [ ] 支持屏蔽文件夹
  - [ ] 支持以下开关
    - [ ] 不扫描60秒以下歌曲
    - [ ] 不扫描amr, mid格式歌曲
    - [ ] 不扫描隐藏文件夹
- [ ] 播放列表
  - [ ] 全部歌曲视图
  - [ ] 歌手列表视图
  - [ ] 专辑列表视图
  - [ ] 文件夹视图
  - [ ] 支持首字母索引
    - [ ] 首字母索引支持日文假名
    - [ ] 首字母索引支持日文中的汉字(优先以中文拼音识别)
    - [ ] 首字母索引可以自动识别并排除歌曲标题中的序号
  - [ ] 支持搜索
- [ ] 播放
  - [ ] 支持基本的播放功能(上一曲下一曲, 进度条控制, 随机播放等)
  - [ ] 支持睡眠模式
  - [ ] 支持均衡器
  - [ ] 耳机断连自动暂停
  - [ ] 正在播放页
    - [ ] 显示歌曲信息
  - [ ] 支持播放队列(fb2k中的ctrl+d)


## 暂不考虑支持的功能

* 歌词
* 自定义歌单
* 删除歌曲(从列表删除或直接删除文件)
* 收藏
* UI主题
* 启动时自动播放
* 启动时从中断处继续播放
* 播放统计
  

## 架构设计

UI使用web技术实现(vue+tailwind), 运行在系统内置webview中
通过jsinterop实现web层与原生层通信(app在前台时, 每0.1秒向前端推送一次播放状态)
音乐播放功能使用ExoPlayer实现
使用sqlite储存播放列表


## 数据结构

### 歌曲
文件名
cue信息(音轨, 开始时间, 结束时间)
id(由文件名+cue音轨组成, 如果不是cue, 则为文件名)
标题
歌手
专辑
时长
文件大小
元数据


### 播放列表
id
标题
歌曲清单(id列表)



## 播放控制器

### 接口
获取/设置当前播放清单(id, 歌曲清单)
播放歌曲(歌曲id)
播放/暂停
下一首/上一首
获取/设置播放模式(循环/随机/单曲循环)
添加到播放队列(歌曲id)  // 如果歌曲不在当前播放清单内则返回失败消息
获取/清空播放队列
获取/设置均衡器
获取/设置睡眠模式

说明: 
* 需要在内存中保存最近播放过的10首歌曲, 用于执行随机模式下的上一曲功能
* 播放队列只需在内存中保存


## 储存

数据全部保存到sqlite中

### 歌曲库
歌曲清单

### 扫描设置

### 播放控制器
当前播放歌曲id, 当前播放列表
当前播放模式, 均衡器设置


## 界面设计

### 歌曲库页面(首页)
顶部4个tab, 分别是歌曲, 歌手, 专辑, 文件夹
中间为对应的列表
底部为播放状态栏

### 播放状态栏控件
显示歌曲名称, 歌手, 提供暂停/播放, 下一曲, 菜单按钮(点击后弹出菜单: 扫描音乐, 睡眠模式, 关于, 退出)
底部显示2px高度的进度条
点击状态栏跳转到正在播放页


### 睡眠模式对话框
菜单->睡眠模式 点击后弹出此对话框
提供选项, 选择多久之后停止播放, 选择后, 菜单中的睡眠模式显示剩余时间, 此时点击则关闭睡眠模式



### 扫描音乐页面
显示扫描设置:
不扫描60秒以下歌曲
不扫描amr, mid格式歌曲
不扫描隐藏文件夹

显示扫描的文件夹列表(可以添加/删除)
显示不扫描的文件夹列表(可以添加/删除)

开始扫描按钮, 点击后显示扫描进度(已扫描数量, 当前扫描文件夹)
扫描完成后显示扫描结果



### 抽象列表控件
可开关的序号显示
可选的项目展开内容
项目固定为标题+副标题
顶部提供搜索框, 搜索标题
高亮当前项
右边提供标题的首字母索引, 点击后跳转到对应首字母的项目
提供项目点击事件
可开关的多选模式, 长按列表进入多选模式, 由调用方提供操作菜单

### 歌曲列表控件

控件参数:
歌曲清单id(全部歌曲, 歌手:<歌手名>, 专辑:<专辑名>, 文件夹:<文件夹路径>)
歌曲清单

基于抽象列表控件
列表显示序号, 歌曲名, 歌手
高亮当前播放的歌曲
提供展开按钮, 可以查看更多歌曲详情, 并提供加入播放队列的按钮
点击歌曲后播放该曲目(调用播放控制器, 如果播放控制器的歌曲清单和当前歌曲清单不一致, 则更新播放控制器的歌曲清单)
多选模式: 将选中的歌曲加入到播放队列


### 歌曲详情控件
展示歌曲的专辑, 音轨, 时长, 文件名, 格式, 大小, 比特率, 采样率等信息

### 文件夹列表控件
歌手和专辑列表也使用文件夹列表来实现
基于抽象列表控件
标题为歌手/专辑/文件夹名称
副标题为歌曲数量
点击后显示动态歌曲列表页面

### 动态歌曲列表页面
页面参数: 
类型: 歌手/专辑/文件夹
值: 对应的歌手/专辑/文件夹

页面标题为参数值
页面底部显示播放状态栏控件
中间显示歌曲列表控件

### 均衡器控件
普通的均衡器

### 正在播放页

顶部显示当前正在播放的歌曲信息(标题+歌手)
中间显示4个tab:
歌曲列表, 数据来自播放控制器(使用歌曲列表控件)
歌曲信息, 显示歌曲详情信息
均衡器
播放队列, 数据来自播放控制器, 提供删除和清空功能

底部显示播放控制:
进度条控制
播放模式切换 上一曲 播放/暂停 下一曲



## 前后端通信

使用webview自带的通信方式, 后端向webview提供js接口, 供前端调用
后端使用执行js的方式, 返回调用结果, 或主动调用前端函数

### 接口调用封装设计

前端调用后端:
```ts
/**
 * 1. 内部生成requestid, 和arg一起传入后端, 并创建Promise等待结果
 * 2. 后端处理请求, 并通过执行js的方式将结果返回给前端
 * 3. 前端在初始化时设置window['__music_api_return__'] = ...
 *    用于接收返回结果, 并将结果传给Promise
 */
let res = await MusicBrige.call('api-name', arg)
```

后端调用前端:
```ts

/**
 * 1. 前端实现注册监听
 * 2. 后端通过执行js的方式调用前端函数
 */
window['__music_api_on_xxx__'] = ...

```

前端接口封装:
```ts

// 强类型api清单
let MusicApi = {
    play: async () => await MusicBrige.call('play', {})
}

```



### 接口清单

* 歌曲库
  * 获取全部歌曲(id, 名称, 歌手)
  * 获取歌曲详情
  * 获取歌手/专辑/文件夹清单
  * 根据歌手/专辑/文件夹获取歌曲清单
* 播放控制(参考播放控制器接口)
* 扫描音乐
  * 修改/获取扫描设置
  * 开始扫描
* 睡眠模式
  * 设置睡眠模式
  * 获取当前睡眠模式设置
* 其他
  * 退出app




